---
layout: post
title: Async RAT - Analysis
date: 15-02-2025
categories: [Malware, RATs]
tag: [Malware, RATs]
---

![Banner AsyncRAT](assets/images/blogs/async-rat/Banner-async.png)

AsyncRAT is a remote access trojan (RAT) built to remotely monitor and control other computers through a secure, encrypted connection. The name "AsyncRAT" comes from its core functionalityâ€”'async' means it performs its operations asynchronously, which means it is capable of executing several tasks simultaneously. AsyncRAT has been observed as being bought, sold, and deployed for years, going through many versions and renditions. Functionality associated with AsyncRAT includes keylogging, remote desktop control, and the ability to enumerate a victim machine and exfiltraing stolen data - among other fucntionality.

In this post, we'll look at the newest version or AsyncRAT, and go over what to expect in terms of output, that being the tangible things we get from analysing trojans - such as the configuration.

So, with that introduction out of the way, let's get into the malware! (No, the Skaven isn't related, just cool)

<img src="assets/images/blogs/async-rat/skaven-scientist.png" alt="Skaven Scientist" width="500" height="500">

## Initialisation

In January 2019 AsyncRAT was released as an open source remote administration tool project on [GitHub](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp). Since then, threat actors and adversaries have used several interesting script loaders and spear phishing attachments to deliver AsyncRAT to targeted hosts or networks in different campaigns over the years. Though, this blog will focus specifically on AsyncRAT rather than the delivery mechanisms used throughout the many campaigns that use this trojan.

AsyncRAT begins it's execution process by sleeping for one second before going through the rest of its initialisation, it is unclear why this happens. In addition, AsyncRAT initialises itself using its settings, and if this errors in any way, AsyncRAT terminates.

```cs
{
	}
	for (int i = 0; i < Convert.ToInt32(Settings.Delay); i++)
{
	Thread.Sleep(1000);
}
	if (!Settings.InitializeSettings())
{	
	Environment.Exit(0);
}
```

The `InitializeSettings` method shows that the malware's configuration is Base64 decoded and AES encrypted. This configuration is decoded and decrypted before use, as shown in the code block below:

```cs
{
bool flag;
	try
	{
		Settings.Key = Encoding.UTF8.GetString(Convert.FromBase64String(Settings.Key));
		Settings.aes256 = new Aes256(Settings.Key);
		Settings.Ports = Settings.aes256.Decrypt(Settings.Ports);
		Settings.Hosts = Settings.aes256.Decrypt(Settings.Hosts);
		Settings.Version = Settings.aes256.Decrypt(Settings.Version);
		Settings.Install = Settings.aes256.Decrypt(Settings.Install);
		Settings.MTX = Settings.aes256.Decrypt(Settings.MTX);
		Settings.Pastebin = Settings.aes256.Decrypt(Settings.Pastebin);
		Settings.Anti = Settings.aes256.Decrypt(Settings.Anti);
		Settings.BDOS = Settings.aes256.Decrypt(Settings.BDOS);
		Settings.Group = Settings.aes256.Decrypt(Settings.Group);
		Settings.Hwid = HwidGen.HWID();
		Settings.Serversignature = Settings.aes256.Decrypt(Settings.Serversignature);
		Settings.ServerCertificate = new X509Certificate2(Convert.FromBase64String(Settings.aes256.Decrypt(Settings.Certificate)));
		flag = Settings.VerifyHash();
	}
	catch
		{
		flag = false;
		}
	return flag;
}
```

As shown in the picture below, the configurations used by the malware, such as the C2 host and ports are indeed encrypted and encoded.

![AsyncRAT config](assets/images/blogs/async-rat/async-config.png)

One of the main goals when analysing trojans is to identify and extract this configuration information, as it's quite telling as to how the malware is built. This will become more apparent later when I dicuss the server side operations, the builder, and how the config structure for AsyncRAT is exactly the same sample to sample, even if the values are different (as many of them are set by the attacker).

One other things to mention is the `flag = Settings.VerifyHash();` check in the code block above. AsyncRAT needs to verify the integrity of it's configurations and return a `true` result. If `false`, AsyncRAT will terminate. The malware also checks if any of the configurations have been changed post compilation, by using `Serversignature` and `ServerCertificate` with the `VerifyHash` function - returning the result. This works like a watermark for wants of a better example. Without this check, we could reverse engineer the malware allot faster since I could manually put in whatever values I wanted by editing the methods, and I'd be able to see the malware's functionality that way.

## Decryption Routine

Insofar as the encrpytion and decryption routine goes, it is reasonbly straightforward and doesn't differ too much from other RATs. The decryption routine for the latest version of ASyncRAT is shown below:

![AsyncRAT config](assets/images/blogs/async-rat/async-decrypt.png)

I am not 100% on this, but I analysed a few samples for this blog and found the encryption key to be exactly the same, and nothing in the builder suggests you can change it, some food for thought around signituring. For my analysis, the AES keys are below:

```
Key (Base64) = ejFjc0p0QWtudENHVTdsakhjTExYbm1KM1RqbTVUMlA=
Key (UTF8) = z1csJtAkntCGU7ljHcLLXnmJ3Tjm5T2P

```

In relation to the decryption routine in whic the key is used, This is how that decrpytion routine works:

* The method `Decrypt` takes an encrypted byte array as input.
* If the input is null, it throws an exception.
* The `AesCryptoServiceProvider` is set with specific variables for decryption.
* An HMAC hash is computed and compared with the one from the input to validate the data.
* Initialization Vector (IV) for the AES operation is read from the input. The IV is generated from the first 16 bytes of the encrypted data
* The encrypted byte array is decrypted using `CryptoStream`.
* The decrypted data is stored in byte arrays, completing with `array6`.
* The function finally returns `array6` which contains the decrypted data.

In the **Detection and Mitigation** section of this blog, I have a python script for doing the full decryption and decoding, as long as you identify and add the values to the script.

## Anti-analysis and defence evasion

There are a few anti-analysis techniques employed by ASyncRAT, which I will discuss presently. Though, anti-analysis is an optional feature provided to users of the ASyncRAT builder that they'll need to toggle to get in their malware.

## Persistence

## Installation

## BSOD

## Command and Control (C2)

## Server Side Ops

## Detection and Mitigation

## Conclusion


