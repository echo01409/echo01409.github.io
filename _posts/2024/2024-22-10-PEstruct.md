---
layout: post
title: Fundamentals - Portable Executable (PE) Structure
date: 22-10-2024
categories: [Fundamentals, Malware]
tag: [Malware, Fundamentals]
---

![Banner PEStruct](assets/images/blogs/PEStruct/PEStruct-Banner.png)

A Portable Executables (PE) is the file format for executables on Windows. A few examples of PE file extensions are `.exe`, `.dll`, `.sys`, and `.scr`. This module discusses the PE structure which is important to know when building or reverse engineering malware.

If you are interested in malware analysis, malware developemnt, or Windows more generally, read on to learn about how Windows PE files are comprised of.

# PE Structure

## DOS Header (IMAGE_DOS_HEADER)

The DOS header is always prefixed with two bytes, `0x4D` and `0x5A`, or `4D5A`, this is commonly referred to as the magic bytes `MZ`. These bytes represent the DOS header signature, which is used to confirm that the file being parsed or inspected is a valid PE file. The DOS header is a data structure, defined as follows in the code block below:

```c
typedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // Offset to the NT header
  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```

## DOS Stub

## NT Header (IMAGE_NT_HEADERS)

### 32-Bit 

### 64-Bit 

## File Header (IMAGE_FILE_HEADER)

## Optional Header (IMAGE_OPTIONAL_HEADER)

### 32-Bit 

### 64-Bit 

## Data Directory

## Export Directory

## Import Address Table (IAT)

## PE Sections