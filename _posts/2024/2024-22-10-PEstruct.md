---
layout: post
title: Fundamentals - Portable Executable (PE) Structure
date: 22-10-2024
categories: [Fundamentals]
tag: [Fundamentals]
---

![Banner PEStruct](assets/images/blogs/PEStruct/PEStruct-Banner.png)

A Portable Executables (PE) is the file format for executables on Windows. A few examples of PE file extensions are `.exe`, `.dll`, `.sys`, and `.scr`. In this blog psot, I'll discuss the Windows PE structure, which is fundamental knowledge to those working in IT, specifically if you work with Windows-based malware in any capacity, as a developer or reverse engineer.

# PE Structure

The diagram below shows a general, simplified structure of a PE file, with every header being a data structure.

![PE-structure-diagram](assets/images/blogs/PEStruct/PE-structure-diagram.png)

## DOS Header (IMAGE_DOS_HEADER)

The DOS header is always prefixed with two bytes, `0x4D` and `0x5A`, or `4D5A`, this is commonly referred to as the magic bytes `MZ`. These bytes represent the DOS header signature, which is used to confirm that the file being parsed or inspected is a valid PE file. The DOS header is a data structure, defined as follows in the code block below:

```c
typedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // Offset to the NT header
  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```
The two members of the above struct which are the most important are the `e_magic` and `e_lfanew`

* `e_magic` is as described above, the Magic Bytes (MZ) denoted as `0x5A4D` here.

* `e_lfanew` is a 4-byte value that holds an offset at the beginning of the NT Header, which is located at `0x3C`

## DOS Stub
The DOS stub is a short piece of code that resides at the beginning of every Portable Executable (PE) file format within Windows operating systems.

This stub is executed when a user tries to run the file on MS-DOS or equivalent platforms. Since PE files can't run on such platforms, the DOS stub usually prints out a message along the lines of **"This program cannot be run in DOS mode."** By default, this is what the DOS stub does, but it can be modified to implement other routines, though it's rarely done because modern systems do not use the MS-DOS environment for execution.

Therefore, the main purpose of the DOS stub in the modern context is to provide backward compatibility and prevent DOS-based systems from executing these PE files and potentially causing system instability.

## NT Header (IMAGE_NT_HEADERS)

The NT header is essential for one key reason: it incorporates the other two image headers contained in a PE file, `FileHeader` and `OptionalHeader`, which together contains a large amount of information about a PE file.

Where the DOS header has a unique signiture to identify it, namely `0x4D` and `0x5A`, the NT header has a unique signiture too, equal to the "PE" string, which is `0x50` and `0x45` bytes. However, since this signiture is of the data type `DWORD`, it'll be represented as `0x50450000`. This is exactly the same as the "PE" string, execpt that it is padded with two null bytes. The `e_lfanew` member is used to reach the NT header.

Depending on the machines' architecture, the NT header structures will be different, see below:

### 32-Bit 

```c
typedef struct _IMAGE_NT_HEADERS {
  DWORD                   Signature;
  IMAGE_FILE_HEADER       FileHeader;
  IMAGE_OPTIONAL_HEADER32 OptionalHeader;
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
```

### 64-Bit 

```c
typedef struct _IMAGE_NT_HEADERS64 {
    DWORD                   Signature;
    IMAGE_FILE_HEADER       FileHeader;
    IMAGE_OPTIONAL_HEADER64 OptionalHeader;
} IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;
```

## File Header (IMAGE_FILE_HEADER)

## Optional Header (IMAGE_OPTIONAL_HEADER)

### 32-Bit 

### 64-Bit 

## Data Directory

## Export Directory

## Import Address Table (IAT)

## PE Sections